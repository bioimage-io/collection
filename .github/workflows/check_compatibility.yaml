name: check compatibility

concurrency: check-compatibility

on:
  workflow_dispatch:
    inputs:
      cache-nr:
        description: 'A number that is increased to force re-running the compatibility checks'
        required: false
        default: '0'
      rerun:
        description: 'Chose a tool to run compatibility checks for even if the index cache is hit.'
        type: choice
        default: 'only-on-index-update'
        required: false
        options:
          [
            only-on-index-update,
            all,
            biapy,
            bioimageio.core,
            careamics,
            ilastik,
          ]

  push:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'

jobs:
  # test-and-docs:
  #   runs-on: ubuntu-latest
  #   environment: testing
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v6
  #       with:
  #         cache: "pip"
  #     - run: pip install -e .[dev]
  #     - run: ruff check
  #     - run: pyright -p pyproject.toml
  #     - run: pytest
  #       env:
  #         RUN_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
  #         BIOIMAGEIO_USER_ID: github|${{github.actor_id}}
  #         HYPHA_API_TOKEN: ${{secrets.HYPHA_API_TOKEN}}
  #     - name: export documentation
  #       run: |
  #         pdoc \
  #         --mermaid \
  #         --docformat google \
  #         --logo https://bioimage.io/static/img/bioimage-io-logo.svg \
  #         --logo-link https://bioimage.io/ \
  #         --favicon https://bioimage.io/static/img/bioimage-io-icon-small.svg \
  #         --footer-text 'backoffice' \
  #         -o ./docs backoffice
  #     - name: Deploy to gh-pages ðŸš€
  #       uses: JamesIves/github-pages-deploy-action@v4
  #       with:
  #         dry-run: ${{ github.ref != 'refs/heads/main' }}
  #         folder: docs
  #         clean: true
  #         clean-exclude: |
  #           backoffice.html
  #           index.html
  #           index.json
  #           reports
  #           search.js

  index:
    # needs: test-and-docs
    uses: ./.github/workflows/index.yaml
    secrets: inherit
    with:
      cache-nr: ${{ inputs.cache-nr || '0' }}

  biapy:
    needs: index
    if: needs.index.outputs.cache-hit != 'true' || contains(github.event.inputs.rerun, 'all') || contains(github.event.inputs.rerun, 'biapy')
    uses: ./.github/workflows/check_compatibility_biapy.yaml
    secrets: inherit
  bioimageio_core:
    needs: index
    if: needs.index.outputs.cache-hit != 'true' || contains(github.event.inputs.rerun, 'all')|| contains(github.event.inputs.rerun, 'bioimageio.core')
    uses: ./.github/workflows/check_compatibility_bioimageio_core.yaml
    secrets: inherit
  careamics:
    needs: index
    if: needs.index.outputs.cache-hit != 'true' || contains(github.event.inputs.rerun, 'all')|| contains(github.event.inputs.rerun, 'careamics')
    uses: ./.github/workflows/check_compatibility_careamics.yaml
    secrets: inherit
  ilastik:
    needs: index
    if: needs.index.outputs.cache-hit != 'true' || contains(github.event.inputs.rerun, 'all')|| contains(github.event.inputs.rerun, 'ilastik')
    uses: ./.github/workflows/check_compatibility_ilastik.yaml
    secrets: inherit

  summarize:
    name: summarize and deploy stage
    needs: [index, biapy, bioimageio_core, careamics, ilastik]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    environment: 'production'
    steps:
      - run: echo ${{ needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update' }}
      - run: echo ${{ needs.index.outputs.cache-hit }}
      - run: echo ${{ github.event.inputs.rerun }}
      # additional 'if' per step as they do not seem to have an affect in `... && !cancelled()`
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        uses: actions/checkout@v4
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        uses: actions/setup-python@v6
        with:
          cache: 'pip'
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        run: pip install .
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        uses: actions/checkout@v4
        name: checkout staged index and reports
        with:
          ref: stage-gh-pages
          path: gh-pages
          sparse-checkout: |
            reports
            index.json
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        name: summarize reports
        run: backoffice summarize
        env:
          REPORTS: gh-pages/reports
          RUN_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
          HYPHA_API_TOKEN: ${{secrets.HYPHA_API_TOKEN}}
      - if: needs.index.outputs.cache-hit != 'true' || github.event.inputs.rerun != 'only-on-index-update'
        name: Deploy to gh-pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: gh-pages
          dry-run: ${{ github.ref != 'refs/heads/main' }}
          clean: false
