name: check compatibility bioimageio_core

on:
  workflow_call:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: 'production'
    steps:
      # - name: Maximize available disk space
      #   uses: AdityaGarg8/remove-unwanted-software@v5
      #   with:
      #     remove-android: 'true'
      #     remove-dotnet: 'true'
      #     remove-haskell: 'true'
      #     remove-codeql: 'true'
      - uses: actions/checkout@v4
      - uses: ./.github/actions/restore_reports
        with:
          tool: bioimageio_core
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          channels: conda-forge
          conda-remove-defaults: 'true'
          activate-environment: 'core'
      - run: python -c "import subprocess; env_list = subprocess.run(['conda', 'env', 'list'], check=True, capture_output=True, encoding='utf-8').stdout; print(env_list)"
        shell: bash -el {0}
      - run: |
          source $CONDA/etc/profile.d/conda.sh
          python -c "import subprocess; subprocess.check_call(['conda', 'activate', 'lalalalal'])"
        shell: bash -el {0}
        if: always()
      - run: |
          source $CONDA/etc/profile.d/conda.sh
          conda activate lalalalal
        shell: bash -el {0}
        if: always()
      - name: Install bioimageio.core and backoffice
        shell: bash -el {0}
        run: pip install . bioimageio.core[dev]
      - run: conda info
        shell: bash -el {0}
      - run: python scripts/check_compatibility_bioimageio_core.py
        shell: bash -el {0}
        env:
          RUN_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
          HYPHA_API_TOKEN: ${{secrets.HYPHA_API_TOKEN}}
      - name: Stage to stage-gh-pages ðŸš€
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: reports
          branch: stage-gh-pages
          dry-run: ${{ github.ref != 'refs/heads/main' }}
          target-folder: reports
          clean: false
      - name: Check final disk space
        run: df -h
