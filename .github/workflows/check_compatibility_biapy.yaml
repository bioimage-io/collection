name: check compatibility biapy

on:
  workflow_call:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: 'production'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/max_disk_space
      - uses: ./.github/actions/restore_reports
        with:
          tool: biapy
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Installing BiaPy dependencies
        run: pip install biapy
      - name: Installing Pytorch
        run: pip install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 --index-url https://download.pytorch.org/whl/cpu
      - name: Installing last packages that rely on the Pytorch installation
        run: pip install timm torchmetrics[image] pytorch-msssim
      - name: Install backoffice
        run: pip install .
      - run: python scripts/check_compatibility_biapy.py
        env:
          RUN_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
          HYPHA_API_TOKEN: ${{secrets.HYPHA_API_TOKEN}}
      - name: Stage to stage-gh-pages ðŸš€
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: stage-gh-pages
          folder: reports
          dry-run: ${{ github.ref != 'refs/heads/main' }}
          target-folder: reports
          clean: false
